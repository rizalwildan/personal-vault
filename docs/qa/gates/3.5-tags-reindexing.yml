schema: 1
story: '3.5'
story_title: 'Tags Management and Manual Re-indexing'
gate: PASS
status_reason: 'All ACs implemented correctly. One bug (case-sensitive color regex) caught and fixed during review. Test coverage expanded from 3 to 14 integration tests. No blocking issues remain.'
reviewer: 'Quinn (Test Architect)'
updated: '2026-02-21T00:00:00Z'

quality_score: 82
expires: '2026-03-07T00:00:00Z'

evidence:
  tests_reviewed: 28
  risks_identified: 3
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28]
    ac_gaps: []

nfr_validation:
  security:
    status: PASS
    notes: 'JWT auth enforced on all 5 endpoints. Ownership check via user_id in all DB queries. NotFoundError used for both missing and unauthorized access (no existence disclosure). No SQL injection vectors â€” Drizzle ORM parameterization throughout.'
  performance:
    status: CONCERNS
    notes: 'removeTagFromNotes uses application-level N loop (one DB UPDATE per note). For MVP scale this is acceptable, but a single SQL array_remove UPDATE would be more efficient at higher note volumes. /reindex also uses per-note updates. No immediate action required.'
  reliability:
    status: PASS
    notes: 'All routes have try/catch error handling. NotFoundError and ConflictError correctly mapped to 404/409. 500 fallback in place. Route ordering verified: /reindex registered before /:id to prevent path collision.'
  maintainability:
    status: PASS
    notes: 'Clean layer separation (repository/service/route). Consistent naming conventions. Auth pattern matches existing notes.routes.ts. Unit tests now have proper mock isolation via afterEach restoration.'

top_issues:
  - id: 'color-regex-case-sensitive'
    severity: high
    status: fixed
    description: 'POST and PATCH body schemas used case-sensitive hex pattern ^#[0-9A-F]{6}$ with a non-functional transform option. Lowercase colors like #3b82f6 would return 400 instead of 201/200.'
    file: 'backend/src/routes/tags.routes.ts'
    fix: 'Changed pattern to ^#[0-9A-Fa-f]{6}$, removed invalid transform option. Fixed in both POST and PATCH schemas.'
    suggested_owner: dev

  - id: 'integration-test-coverage-gap'
    severity: medium
    status: fixed
    description: 'tags.crud.test.ts had only 3 of 9 planned tests. ACs for alphabetical sort, note_count field, 400 validation, PATCH operations, and DELETE 404 had no integration coverage.'
    file: 'backend/tests/integration/routes/tags.crud.test.ts'
    fix: 'Expanded from 3 to 14 tests covering all critical ACs.'
    suggested_owner: dev

  - id: 'unit-test-mock-pollution'
    severity: low
    status: fixed
    description: 'Unit tests mutate the tagsRepository singleton methods without restoring them, risking cross-test contamination if test order changes or new tests are added.'
    file: 'backend/tests/unit/services/tags.uniqueness.test.ts'
    fix: 'Added afterEach that restores original methods from a pre-captured originalMethods object.'
    suggested_owner: dev

recommendations:
  immediate: []
  future:
    - action: 'Replace removeTagFromNotes N+1 loop with single SQL: UPDATE notes SET tags = array_remove(tags, $tagName) WHERE user_id=$userId AND tags @> ARRAY[$tagName]'
      refs: ['backend/src/repositories/tags.repository.ts']
    - action: 'Migrate ConflictError/NotFoundError/ValidationError to extend AppError base class with statusCode property (per architecture/error-handling-strategy.md)'
      refs: ['backend/src/utils/errors.ts']
    - action: 'Align cascade.test.ts cleanup to use TRUNCATE CASCADE (consistent with crud.test.ts)'
      refs: ['backend/tests/integration/routes/tags.cascade.test.ts']
    - action: 'Update api-specification.md to document POST /api/v1/notes/reindex bulk endpoint (currently undocumented)'
      refs: ['docs/architecture/api-specification.md']

waiver:
  active: false
