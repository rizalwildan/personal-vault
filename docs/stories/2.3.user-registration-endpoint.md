# Story 2.3: User Registration Endpoint

**Status:** Not Started
**Priority:** High
**Estimate:** 2-3 days
**Epic:** Epic 2 — Backend Authentication System

---

## Story

**As a** backend developer,
**I want** a complete user registration endpoint,
**so that** new users can create accounts with secure password hashing and receive JWT tokens for immediate authentication.

---

## Acceptance Criteria

1. `POST /api/v1/auth/register` endpoint accepts JSON body matching `RegisterSchema`
2. Email uniqueness validation returns 409 Conflict if email already exists
3. Password complexity validation returns 400 Bad Request for weak passwords
4. Terms acceptance validation requires `terms_accepted: true` (400 Bad Request if false)
5. Password stored as bcrypt hash (never plaintext) in database
6. Returns 201 Created with user object, access_token, and refresh_token
7. Refresh token stored in sessions table as SHA-256 hash
8. Integration tests cover success and all error cases

---

## Tasks / Subtasks

- [ ] Create auth routes file `backend/src/routes/auth.ts`
  - [ ] Set up Hono router for auth endpoints
  - [ ] Import required utilities and schemas
  - [ ] Export auth router for mounting in main app
- [ ] Implement registration endpoint logic
  - [ ] Parse and validate request body with `RegisterSchema`
  - [ ] Check email uniqueness in users table
  - [ ] Hash password using `hashPassword` utility
  - [ ] Create user record in database
  - [ ] Generate access and refresh tokens
  - [ ] Store refresh token hash in sessions table
  - [ ] Return success response with user data and tokens
- [ ] Implement error handling
  - [ ] 409 Conflict for duplicate email
  - [ ] 400 Bad Request for validation errors
  - [ ] Proper error messages without sensitive information
- [ ] Mount auth routes in main application
  - [ ] Import auth router in `backend/src/app.ts`
  - [ ] Mount at `/api/v1/auth` path
  - [ ] Test endpoint is accessible
- [ ] Write integration tests
  - [ ] Test successful registration
  - [ ] Test duplicate email error
  - [ ] Test password validation errors
  - [ ] Test terms acceptance validation
  - [ ] Verify database records created correctly
  - [ ] Verify tokens are valid and usable

---

## Dev Notes

### Previous Story Context

**From Story 2.2 (JWT Utilities and Password Hashing):**

- Password hashing utilities (`hashPassword`, `comparePassword`) implemented
- JWT utilities (`signAccessToken`, `signRefreshToken`) implemented
- Authentication middleware available for future protected routes
- Environment variables configured for JWT secrets

**From Story 2.1 (Database Schema for Users and Sessions):**

- Users and sessions tables fully implemented and migrated
- Database connection established via Drizzle ORM
- Zod schemas available for validation

### Source Tree Context

Current project structure (relevant portions):

```
personal-vault/
├── backend/
│   ├── src/
│   │   ├── app.ts                # EXISTS - Main Hono app
│   │   ├── routes/
│   │   │   ├── index.ts          # EXISTS - Route exports
│   │   │   └── auth.ts           # CREATE - Auth endpoints
│   │   ├── utils/
│   │   │   └── auth.ts           # EXISTS - From Story 2.2
│   │   ├── middleware/
│   │   │   └── auth.ts           # EXISTS - From Story 2.2
│   │   ├── db/
│   │   │   ├── client.ts         # EXISTS - Database connection
│   │   │   └── schema/
│   │   │       ├── index.ts      # EXISTS - Schema exports
│   │   │       ├── users.ts      # EXISTS - Users schema
│   │   │       └── sessions.ts   # EXISTS - Sessions schema
│   │   └── services/             # CREATE - Business logic (future)
│   ├── tests/
│   │   ├── integration/          # EXISTS - Integration tests
│   │   │   └── auth.test.ts      # CREATE - Auth endpoint tests
│   │   └── unit/                 # EXISTS - Unit tests
│   ├── package.json              # EXISTS - Dependencies
│   └── tsconfig.json             # EXISTS - TypeScript config
├── shared/
│   └── schemas/
│       ├── index.ts              # EXISTS - Schema exports
│       ├── user.ts               # EXISTS - User schemas
│       └── session.ts            # EXISTS - Session schemas
```

### API Contract Details

**Endpoint:** `POST /api/v1/auth/register`

**Request Body Schema:**

```typescript
// From shared/schemas/user.ts
export const RegisterSchema = z.object({
  email: z.string().email(),
  password: z
    .string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain uppercase letter')
    .regex(/[a-z]/, 'Password must contain lowercase letter')
    .regex(/[0-9]/, 'Password must contain number'),
  name: z.string().min(1).max(100),
  terms_accepted: z.literal(true, {
    errorMap: () => ({ message: 'You must accept terms and conditions' }),
  }),
});
```

**Success Response (201 Created):**

```typescript
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid-string",
      "email": "user@example.com",
      "name": "John Developer",
      "avatar_url": null,
      "terms_accepted_at": "2026-02-17T10:30:00Z",
      "created_at": "2026-02-17T10:30:00Z",
      "updated_at": "2026-02-17T10:30:00Z"
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**Error Responses:**

- **400 Bad Request** - Validation errors:

```typescript
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input data",
    "details": [
      { "field": "email", "message": "Invalid email format" },
      { "field": "password", "message": "Password must contain uppercase letter" }
    ]
  }
}
```

- **409 Conflict** - Email already exists:

```typescript
{
  "success": false,
  "error": {
    "code": "EMAIL_EXISTS",
    "message": "An account with this email already exists"
  }
}
```

### Implementation Details

**Route Implementation:**

```typescript
// backend/src/routes/auth.ts
import { Hono } from 'hono';
import { zValidator } from '@hono/zod-validator';
import { RegisterSchema } from '../../../shared/schemas/user';
import { db } from '../db/client';
import { users, sessions } from '../db/schema';
import { eq } from 'drizzle-orm';
import { hashPassword, signAccessToken, signRefreshToken } from '../utils/auth';
import { createHash } from 'crypto';

const auth = new Hono();

auth.post('/register', zValidator('json', RegisterSchema), async (c) => {
  const { email, password, name, terms_accepted } = c.req.valid('json');

  // Check if email already exists
  const existingUser = await db.query.users.findFirst({
    where: eq(users.email, email),
  });

  if (existingUser) {
    return c.json(
      {
        success: false,
        error: {
          code: 'EMAIL_EXISTS',
          message: 'An account with this email already exists',
        },
      },
      409,
    );
  }

  // Hash password
  const passwordHash = await hashPassword(password);

  // Create user
  const [newUser] = await db
    .insert(users)
    .values({
      email,
      password_hash: passwordHash,
      name,
      terms_accepted_at: new Date(),
    })
    .returning();

  // Generate tokens
  const accessToken = await signAccessToken(newUser.id);
  const refreshToken = await signRefreshToken(newUser.id);

  // Store refresh token hash
  const refreshTokenHash = createHash('sha256')
    .update(refreshToken)
    .digest('hex');
  await db.insert(sessions).values({
    user_id: newUser.id,
    token_hash: refreshTokenHash,
    expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
  });

  // Return success response
  return c.json(
    {
      success: true,
      data: {
        user: {
          id: newUser.id,
          email: newUser.email,
          name: newUser.name,
          avatar_url: newUser.avatar_url,
          terms_accepted_at: newUser.terms_accepted_at,
          created_at: newUser.created_at,
          updated_at: newUser.updated_at,
        },
        access_token: accessToken,
        refresh_token: refreshToken,
      },
    },
    201,
  );
});

export { auth };
```

**App Integration:**

```typescript
// backend/src/app.ts
import { auth } from './routes/auth';

// ... existing code ...

app.route('/api/v1/auth', auth);
```

### Database Operations

**User Creation:**

- Insert into `users` table with hashed password
- Set `terms_accepted_at` to current timestamp
- Return the created user record

**Session Creation:**

- Generate refresh token and compute SHA-256 hash
- Insert into `sessions` table with:
  - `user_id`: New user's ID
  - `token_hash`: SHA-256 hash of refresh token
  - `expires_at`: 30 days from now

### Security Considerations

- **Password Security:** Never store plaintext passwords, always hash with bcrypt
- **Token Security:** Store only refresh token hash in database, never the token itself
- **Input Validation:** Use Zod schemas for comprehensive validation
- **Error Handling:** Don't leak sensitive information in error messages
- **Rate Limiting:** Consider implementing rate limiting for registration endpoint (future story)

### Testing Strategy

**Integration Tests:**

```typescript
// backend/tests/integration/auth.test.ts
import { describe, it, expect } from 'bun:test';
import { testClient } from '../test-utils';

describe('POST /api/v1/auth/register', () => {
  it('should create user successfully', async () => {
    const response = await testClient.post('/api/v1/auth/register').json({
      email: 'test@example.com',
      password: 'SecurePass123',
      name: 'Test User',
      terms_accepted: true,
    });

    expect(response.status).toBe(201);
    const data = await response.json();
    expect(data.success).toBe(true);
    expect(data.data.user.email).toBe('test@example.com');
    expect(data.data.access_token).toBeDefined();
    expect(data.data.refresh_token).toBeDefined();
  });

  it('should reject duplicate email', async () => {
    // First registration
    await testClient.post('/api/v1/auth/register').json({
      email: 'duplicate@example.com',
      password: 'SecurePass123',
      name: 'Test User',
      terms_accepted: true,
    });

    // Second registration with same email
    const response = await testClient.post('/api/v1/auth/register').json({
      email: 'duplicate@example.com',
      password: 'SecurePass456',
      name: 'Another User',
      terms_accepted: true,
    });

    expect(response.status).toBe(409);
    const data = await response.json();
    expect(data.error.code).toBe('EMAIL_EXISTS');
  });

  // Additional test cases...
});
```

### Performance Considerations

- Database query for email uniqueness check
- Password hashing is CPU-intensive (async operation)
- Token generation and database insert for session
- Consider database connection pooling for concurrent requests

### Dependencies

**Runtime Dependencies:**

- `@hono/zod-validator` - For request validation (likely already included)
- `crypto` - Node.js built-in for SHA-256 hashing

**Development Dependencies:**

- Test utilities for integration testing

---

## Change Log

| Date       | Version | Description               | Author             |
| ---------- | ------- | ------------------------- | ------------------ |
| 2026-02-17 | 0.1     | Initial draft from Epic 2 | Bob (Scrum Master) |

---

## File List

**Source Files to Create:**

- `backend/src/routes/auth.ts` - Authentication routes
- `backend/tests/integration/auth.test.ts` - Integration tests

**Source Files to Modify:**

- `backend/src/app.ts` - Mount auth routes
- `backend/src/routes/index.ts` - Export auth routes

**Source Files to Verify:**

- `backend/src/utils/auth.ts` - JWT and password utilities
- `backend/src/db/schema/index.ts` - Schema exports
- `shared/schemas/user.ts` - RegisterSchema validation

---

## Dev Agent Record

**Agent Model Used:** Grok Code Fast 1

**Debug Log References:** None - draft only.

**Completion Notes List:**

- Story drafted based on Epic 2 requirements
- Complete API contract with request/response examples
- Implementation details provided for developer handoff
- Security, testing, and performance considerations included

---

## QA Results

**Not Applicable** - Story not yet implemented.

### Recommended Status

Ready for development assignment.</content>
<parameter name="filePath">/Users/developer/NodeProject/personal-vault/docs/stories/2.3.user-registration-endpoint.md
