# Story 3.4: Read, Update, Delete Notes Endpoints

**Status:** Approved

**Epic:** Epic 3 - Backend Notes CRUD & Embedding Generation

---

## Story

**As a** frontend developer,
**I want** to retrieve, update, and delete individual notes with proper authorization,
**so that** users can access, modify, and remove their knowledge base entries.

---

## Acceptance Criteria

- [ ] GET /api/v1/notes/:id returns single note (200 OK)
- [ ] GET /api/v1/notes/:id returns 404 Not Found if note doesn't exist
- [ ] GET /api/v1/notes/:id returns 404 if note belongs to different user (authorization)
- [ ] PATCH /api/v1/notes/:id validates request with UpdateNoteSchema
- [ ] PATCH /api/v1/notes/:id allows partial updates (all fields optional)
- [ ] PATCH /api/v1/notes/:id updates allowed fields: title, content, tags, is_archived
- [ ] PATCH /api/v1/notes/:id returns updated note with updated_at timestamp
- [ ] PATCH /api/v1/notes/:id detects content changes (comparing old vs new)
- [ ] PATCH /api/v1/notes/:id re-queues embedding if content changed
- [ ] PATCH /api/v1/notes/:id preserves embedding_status if only non-content fields updated
- [ ] PATCH /api/v1/notes/:id returns 404 if note doesn't exist or doesn't belong to user
- [ ] PATCH /api/v1/notes/:id returns 400 Bad Request for validation errors
- [ ] DELETE /api/v1/notes/:id soft deletes note (sets is_archived=true)
- [ ] DELETE /api/v1/notes/:id returns 200 OK with success: true, data: null
- [ ] DELETE /api/v1/notes/:id returns 404 if note doesn't exist or doesn't belong to user
- [ ] DELETE /api/v1/notes/:id does NOT hard delete (data preserved)
- [ ] All three endpoints require JWT authentication
- [ ] All endpoints check user ownership (user_id must match authenticated user)
- [ ] All endpoints handle authorization errors as 404 Not Found (never revealing note ownership to unauthorized users)
- [ ] Response formats follow standard: { success: true, data: {...} } or { success: false, error: {...} }
- [ ] Integration tests cover happy path for each endpoint
- [ ] Integration tests cover authorization failures
- [ ] Integration tests cover not found scenarios
- [ ] Integration tests cover content change detection and re-queuing

---

## Tasks / Subtasks

- [ ] Task 1: Implement GET /api/v1/notes/:id in NotesService (AC: 1, 2, 3)
  - **Prerequisite:** Complete Task 3 (Repository Methods) before this task
  - [ ] Create `getById(noteId, userId)` async method in NotesService
  - [ ] Call repository to fetch note: `repository.findByUserAndId(userId, noteId)` (ownership enforced at DB level — WHERE id=$1 AND user_id=$2)
  - [ ] If note not found (null returned), throw NotFoundError('Note') — covers both "doesn't exist" and "belongs to different user" cases
  - [ ] Return note object

- [ ] Task 2: Implement GET /api/v1/notes/:id Route Handler (AC: 1, 2, 3, 19)
  - [ ] Add GET /:id handler to notes.routes.ts
  - [ ] Parameters: :id (note ID as UUID)
  - [ ] Handler: async ({ user, params }) => { ... }
  - [ ] Call: notesService.getById(params.id, user.id)
  - [ ] Return: { success: true, data: note }
  - [ ] Response status: 200
  - [ ] Response validation with t.Object schema
  - [ ] Error handling: NotFoundError → 404 (covers both not-found and unauthorized access)

- [ ] Task 3: Implement Repository Methods for Update/Delete (AC: 5, 6, 7)
  - **Note:** `findByUserAndId(userId, noteId)` was specified in Story 3.3 Task 2 — verify it already exists in `notes.repository.ts` before reimplementing. Only `update()` and `softDelete()` are new methods required for this story.
  - [ ] Confirm or add to NotesRepository:
    - [ ] `findByUserAndId(userId, noteId)` - Find with ownership check (verify exists from Story 3.3 first)
    - [ ] `update(noteId, updates)` - Update fields, return updated note (new)
    - [ ] `softDelete(noteId)` - Set is_archived=true (new)
  - [ ] `findByUserAndId()` method (if not already present):
    - [ ] Query: SELECT \* FROM notes WHERE id=$1 AND user_id=$2
    - [ ] Return note or null
  - [ ] `update()` method:
    - [ ] Accept partial update object (only changed fields)
    - [ ] Update only provided fields
    - [ ] Auto-set updated_at timestamp database-side or in service
    - [ ] Use Drizzle partial updates: db.update(notes).set({ ...updates })
    - [ ] Return updated note via .returning()
  - [ ] `softDelete()` method:
    - [ ] Update: is_archived=true
    - [ ] Set updated_at timestamp
    - [ ] Return deleted note (for verification)

- [ ] Task 4: Implement PATCH /api/v1/notes/:id in NotesService (AC: 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `update(noteId, userId, input)` async method
  - [ ] Validate input with UpdateNoteSchema (partial validation)
  - [ ] Fetch current note: `repository.findByUserAndId(userId, noteId)`
  - [ ] If not found, throw NotFoundError('Note')
  - [ ] Detect content change: `newContent && newContent !== currentNote.content`
  - [ ] If content changed:
    - [ ] Set updateData.embedding_status = 'pending'
    - [ ] Clear embedding: updateData.embedding = null (optional, DB can handle)
  - [ ] If content NOT changed:
    - [ ] Preserve embedding_status (don't modify)
  - [ ] Call: `repository.update(noteId, updateData)`
  - [ ] If content changed:
    - [ ] Queue embedding: `embeddingQueue.enqueue(noteId)` — EmbeddingService fetches note content internally, no text parameter needed
  - [ ] Return updated note object

- [ ] Task 5: Implement PATCH /api/v1/notes/:id Route Handler (AC: 4, 5, 6, 7, 9, 11, 12, 19)
  - [ ] Add PATCH /:id handler to notes.routes.ts
  - [ ] Parameters: :id (note ID)
  - [ ] Handler: async ({ user, params, body }) => { ... }
  - [ ] Call: notesService.update(params.id, user.id, body)
  - [ ] Return: { success: true, data: updatedNote }
  - [ ] Response status: 200
  - [ ] Body validation: UpdateNoteSchema (with Elysia t.Partial())
  - [ ] Error handling: NotFoundError → 404, ValidationError → 400

- [ ] Task 6: Implement DELETE /api/v1/notes/:id in NotesService (AC: 13, 14, 15, 16)
  - [ ] Create `delete(noteId, userId)` async method
  - [ ] Fetch note: `repository.findByUserAndId(userId, noteId)`
  - [ ] If not found, throw NotFoundError('Note')
  - [ ] Soft delete: `repository.softDelete(noteId)`
  - [ ] Return null or success indicator (not used, but for consistency)

- [ ] Task 7: Implement DELETE /api/v1/notes/:id Route Handler (AC: 13, 14, 15, 16, 19)
  - [ ] Add DELETE /:id handler to notes.routes.ts
  - [ ] Parameters: :id (note ID)
  - [ ] Handler: async ({ user, params }) => { ... }
  - [ ] Call: notesService.delete(params.id, user.id)
  - [ ] Return: { success: true, data: null }
  - [ ] Response status: 200
  - [ ] Error handling: NotFoundError → 404

- [ ] Task 8: Add Authorization Checks to Route Handlers (AC: 17, 18, 20)
  - [ ] All three new handlers already require JWT via authMiddleware
  - [ ] user.id available in context (from JWT payload)
  - [ ] User ownership verified in service layer (repository queries)
  - [ ] Double-check: service methods receive both noteId and userId
  - [ ] Never return 403 (use 404 for missing/unauthorized)
  - [ ] Rationale: Don't reveal if user doesn't own note (404 is safer)

- [ ] Task 9: Unit Tests for Content Change Detection (AC: 8, 9, 10)
  - [ ] Create `backend/tests/unit/services/notes.update.test.ts`
  - [ ] Test 1: Content changed - embedding_status reset to pending
    - [ ] Current note: title='Old', content='Old content'
    - [ ] Update: content='New content'
    - [ ] Assert embedding_status='pending'
  - [ ] Test 2: Only title changed - embedding_status unchanged
    - [ ] Current note: embedding_status='completed'
    - [ ] Update: title='New title' (no content change)
    - [ ] Assert embedding_status still 'completed'
  - [ ] Test 3: Tags changed - embedding_status unchanged
    - [ ] Current note: embedding_status='completed'
    - [ ] Update: tags=['newtag']
    - [ ] Assert embedding_status still 'completed'
  - [ ] Test 4: Only is_archived changed - embedding_status unchanged
    - [ ] Current note: embedding_status='pending'
    - [ ] Update: is_archived=true
    - [ ] Assert embedding_status still 'pending'
  - [ ] Test 5: Partial content update
    - [ ] Current note: content='Line 1\nLine 2'
    - [ ] Update: content='Line 1\nLine 2 MODIFIED'
    - [ ] Assert content changed detected

- [ ] Task 10: Integration Tests for GET /notes/:id (AC: 1, 2, 3, 21)
  - [ ] Create `backend/tests/integration/routes/notes.read.test.ts`
  - [ ] Setup: Create test user with test note
  - [ ] Teardown: Clean up after each test
  - [ ] Test 1: Get note successfully
    - [ ] GET /api/v1/notes/:id
    - [ ] Assert HTTP 200
    - [ ] Assert success=true
    - [ ] Assert returned note has all fields (id, title, content, tags, etc.)
    - [ ] Assert note belongs to correct user
  - [ ] Test 2: Not found - note doesn't exist
    - [ ] GET /api/v1/notes/nonexistent-id
    - [ ] Assert HTTP 404
    - [ ] Assert success=false
    - [ ] Assert error.code matches (NOT_FOUND or similar)
  - [ ] Test 3: Authorization - user tries to access other user's note
    - [ ] Create note owned by user A
    - [ ] Login as user B
    - [ ] GET /api/v1/notes/:idOfUserANote
    - [ ] Assert HTTP 404 (don't reveal note exists)
  - [ ] Test 4: Requires authentication
    - [ ] GET /api/v1/notes/:id without JWT
    - [ ] Assert HTTP 401 Unauthorized

- [ ] Task 11: Integration Tests for PATCH /notes/:id (AC: 4, 5, 6, 7, 8, 9, 10, 11, 12, 22)
  - [ ] Create `backend/tests/integration/routes/notes.update.test.ts`
  - [ ] Setup: Create test user with test note
  - [ ] Test 1: Update title only
    - [ ] Note current embedding_status
    - [ ] PATCH /api/v1/notes/:id with title='New title'
    - [ ] Assert HTTP 200
    - [ ] Assert success=true
    - [ ] Assert returned note title='New title'
    - [ ] Assert embedding_status unchanged (query DB)
  - [ ] Test 2: Update content - triggers re-indexing
    - [ ] PATCH /api/v1/notes/:id with content='New content'
    - [ ] Assert embedding_status='pending'
    - [ ] Verify embeddingQueue.enqueue() called (mock or wait)
    - [ ] Or just verify status='pending' if async queue not directly testable
  - [ ] Test 3: Update tags only
    - [ ] PATCH /api/v1/notes/:id with tags=['newtag', 'anothertag']
    - [ ] Assert tags updated
    - [ ] Assert embedding_status unchanged
  - [ ] Test 4: Update is_archived (soft delete via PATCH)
    - [ ] PATCH /api/v1/notes/:id with is_archived=true
    - [ ] Assert is_archived=true
    - [ ] Assert embedding_status unchanged
  - [ ] Test 5: Partial update (multiple fields)
    - [ ] PATCH with title + tags (no content)
    - [ ] Assert title updated, tags updated
    - [ ] Assert embedding_status unchanged
  - [ ] Test 6: Empty update (no fields)
    - [ ] PATCH /api/v1/notes/:id with {}
    - [ ] Assert HTTP 200 (or validate at schema level)
    - [ ] Assert nothing changed
  - [ ] Test 7: Validation error - title too long
    - [ ] PATCH with title > 200 chars
    - [ ] Assert HTTP 400
  - [ ] Test 8: Not found
    - [ ] PATCH nonexistent note ID
    - [ ] Assert HTTP 404
  - [ ] Test 9: Authorization - update other user's note
    - [ ] Create note (user A), try to update as user B
    - [ ] Assert HTTP 404

- [ ] Task 12: Integration Tests for DELETE /notes/:id (AC: 13, 14, 15, 16, 23)
  - [ ] Create `backend/tests/integration/routes/notes.delete.test.ts`
  - [ ] Setup: Create test user with notes
  - [ ] Test 1: Soft delete successfully
    - [ ] DELETE /api/v1/notes/:id
    - [ ] Assert HTTP 200
    - [ ] Assert success=true
    - [ ] Assert data=null (or empty object)
    - [ ] Verify in DB: is_archived=true
    - [ ] Verify note still exists (not hard deleted)
  - [ ] Test 2: Deleted note no longer appears in list
    - [ ] Delete a note
    - [ ] GET /api/v1/notes (list)
    - [ ] Assert deleted note NOT in results (default is_archived=false)
  - [ ] Test 3: Can retrieve deleted note with is_archived=true flag
    - [ ] Delete note A
    - [ ] GET /api/v1/notes?is_archived=true
    - [ ] Assert deleted note appears
  - [ ] Test 4: Not found - note doesn't exist
    - [ ] DELETE nonexistent ID
    - [ ] Assert HTTP 404
  - [ ] Test 5: Authorization - delete other user's note
    - [ ] Create note (user A), try to delete as user B
    - [ ] Assert HTTP 404
  - [ ] Test 6: Double-delete is safe (idempotent)
    - [ ] Delete note
    - [ ] Delete same note again
    - [ ] Assert still soft-deleted (second DELETE returns 404)

- [ ] Task 13: Edge Cases and Error Handling (AC: 12, 23)
  - [ ] Concurrent updates: Two users simultaneously update different notes
    - [ ] Assert no race conditions, both succeed
  - [ ] Update with no changes: PATCH with same content
    - [ ] Should work, but embedding NOT re-queued
    - [ ] Compare strings exactly (case-sensitive)
  - [ ] Null/undefined handling in partial updates
    - [ ] Ensure UpdateNoteSchema doesn't require fields
    - [ ] PATCH with { title: undefined } should not update (Drizzle behavior)
  - [ ] Special characters in title/content
    - [ ] Test with emoji, unicode, markdown syntax
    - [ ] Assert stored and retrieved correctly

---

## Dev Notes

### Previous Story Context

Stories 3.1, 3.2, and 3.3 completed:

- Database schema with notes table (Story 3.1)
- Embedding service with queue (Story 3.2)
- Embedding queue management (Story 3.2)
- POST /api/v1/notes and GET /api/v1/notes routes (Story 3.3)
- NotesService and NotesRepository basic methods (Story 3.3)

This story extends routes and service with read/update/delete operations.

### Get Single Note Endpoint

[Source: architecture/api-specification.md#GET-notes-id]

**Response (200 OK):**

```typescript
{
  success: true,
  data: {
    id: string;
    user_id: string;
    title: string;
    content: string;
    embedding_status: 'pending' | 'processing' | 'completed' | 'failed';
    tags: string[];
    is_archived: boolean;
    created_at: string;
    updated_at: string;
  }
}
```

**Errors:**

- `404 Not Found` - Note doesn't exist or doesn't belong to user
- `401 Unauthorized` - Missing JWT token

### Update Note Endpoint

[Source: architecture/api-specification.md#PATCH-notes-id]

**Request:**

```typescript
{
  title?: string;           // Optional
  content?: string;         // Optional
  tags?: string[];          // Optional, replaces existing
  is_archived?: boolean;    // Optional
}
```

**Response (200 OK):**

```typescript
{
  success: true,
  data: {
    id: string;
    user_id: string;
    title: string;
    content: string;
    embedding_status: 'pending' | 'processing' | 'completed' | 'failed';
    tags: string[];
    is_archived: boolean;
    created_at: string;
    updated_at: string;
  }
}
```

**Errors:**

- `404 Not Found` - Note doesn't exist or doesn't belong to user
- `400 Bad Request` - Validation errors

**Key Logic:**

- Content change detection: If new content !== old content, set embedding_status='pending'
- Non-content updates: Preserve existing embedding_status
- Partial updates: Only update provided fields

### Delete Note Endpoint

[Source: architecture/api-specification.md#DELETE-notes-id]

**Response (200 OK):**

```typescript
{
  success: true,
  data: null
}
```

**Errors:**

- `404 Not Found` - Note doesn't exist or doesn't belong to user

**Key Logic:**

- Soft delete only: Set is_archived=true
- Never hard delete (data preserved for compliance)
- Deleted notes excluded from GET /notes (default is_archived=false)
- Deleted notes retrievable with is_archived=true filter

### Content Change Detection

[Source: Epic 3 Story 4 description]

**When Content Changes:**

- Reset embedding_status to 'pending'
- Clear embedding vector (will be regenerated)
- Queue embedding asynchronously

**When Content Unchanged (e.g., only tags/title):**

- Preserve embedding_status
- No re-queuing

**Implementation:**

```typescript
import { embeddingQueue } from '@/queues/embedding.queue'; // import path

const contentChanged =
  updates.content && updates.content !== currentNote.content;
if (contentChanged) {
  updateData.embedding_status = 'pending';
  embeddingQueue.enqueue(noteId); // enqueue accepts only noteId — EmbeddingService fetches content internally
}
```

### Database Query Patterns

[Source: architecture/database-schema.md]

**Find note with user check:**

```typescript
const note = await db
  .select()
  .from(notes)
  .where(and(eq(notes.id, noteId), eq(notes.user_id, userId)))
  .limit(1);

if (!note.length) {
  throw new NotFoundError('Note');
}
```

**Update partial:**

```typescript
const updated = await db
  .update(notes)
  .set({
    ...updates,
    updated_at: new Date(),
  })
  .where(eq(notes.id, noteId))
  .returning();
```

**Soft delete:**

```typescript
const deleted = await db
  .update(notes)
  .set({
    is_archived: true,
    updated_at: new Date(),
  })
  .where(eq(notes.id, noteId))
  .returning();
```

### Authorization Pattern

[Source: architecture/backend-architecture.md#Authentication-Middleware & error patterns]

**Always check ownership in service layer:**

1. Fetch note with WHERE user_id = authenticated userId
2. If not found → NotFoundError (404)
3. If found but different user → Also NotFoundError (404, don't reveal)
4. Never throw UnauthorizedError for note access (403 not standard for this)

**Why 404 instead of 403?**

- Privacy: Don't reveal if note exists to unauthorized user
- Simplicity: Same error for "doesn't exist" and "not yours"
- Standard: Most REST APIs use this pattern

### Validation with Zod

[Source: architecture/coding-standards.md]

**UpdateNoteSchema from Story 3.1:**

```typescript
export const UpdateNoteSchema = z.object({
  title: z.string().min(1).max(200).optional(),
  content: z.string().min(1).optional(),
  tags: z.array(z.string()).optional(),
  is_archived: z.boolean().optional(),
});
```

**Elysia Route Validation:**

```typescript
.patch(
  '/:id',
  handler,
  {
    params: t.Object({ id: t.String() }),
    body: t.Partial(UpdateNoteSchema),
  }
)
```

### Error Handling Strategy

[Source: architecture/error-handling-strategy.md#Backend-Error-Handling]

**Common Errors:**

- `ValidationError` (400) - UpdateNoteSchema validation fails
- `NotFoundError` (404) - Note doesn't exist or not owned
- Generic 500 - Database/runtime errors

**Usage:**

```typescript
import { ValidationError, NotFoundError } from '@/types/errors';

if (!input.title && input.title.length > 200) {
  throw new ValidationError('Title too long');
}

const note = await repo.findByUserAndId(userId, noteId);
if (!note) {
  throw new NotFoundError('Note');
}
```

### Project Structure

[Source: architecture/unified-project-structure.md]

**Files Modified:**

- `backend/src/services/notes.service.ts` - Add getById(), update(), delete()
- `backend/src/repositories/notes.repository.ts` - Add findByUserAndId(), update(), softDelete()
- `backend/src/routes/notes.routes.ts` - Add GET /:id, PATCH /:id, DELETE /:id handlers

**Testing Structure:**

- `backend/tests/unit/services/notes.update.test.ts`
- `backend/tests/integration/routes/notes.read.test.ts`
- `backend/tests/integration/routes/notes.update.test.ts`
- `backend/tests/integration/routes/notes.delete.test.ts`

### Testing Strategy

[Source: architecture/testing-strategy.md#Backend-Testing]

**Test Framework:** Bun Test (Jest-compatible)

**Unit Tests:**

- Content change detection logic
- Partial update handling
- Edge cases (empty updates, null values)

**Integration Tests:**

- Happy path: GET, PATCH, DELETE with valid data
- Authorization: User can't access other user's notes
- Errors: 404, 400, 401 scenarios
- Embedding queue: Content change triggers re-queuing
- Soft delete: Note marked archived, not hard deleted

### Response Format Consistency

[Source: architecture/api-specification.md#Base-Configuration]

**All Responses:**

```typescript
// Success
{ success: true, data: T }

// Error
{ success: false, error: { code: string, message: string, details?: unknown } }
```

**Error Response Examples:**

```typescript
// 404
{
  success: false,
  error: {
    code: 'NOT_FOUND',
    message: 'Note not found'
  }
}

// 400
{
  success: false,
  error: {
    code: 'VALIDATION_ERROR',
    message: 'Validation failed',
    details: { title: ['Title must be shorter than 200 characters'] }
  }
}
```

### Soft Delete Pattern

**Rationale:**

- Data preservation (audit trail, compliance)
- Reversible (can un-archive if needed)
- Logical deletion (hidden from normal queries)

**Implementation:**

- Set is_archived=true
- Never remove from database
- GET /notes defaults to is_archived=false (excludes deleted)
- GET /notes?is_archived=true includes deleted notes

### No Hard Delete

- **Not Implemented:** DELETE should not remove from database
- **MVP Approach:** Soft delete sufficient for user experience
- **Future:** Purge permanently deleted notes after 30-day retention

> **Arch Doc Note:** `docs/architecture/api-specification.md` DELETE /notes/:id description currently reads "Permanently delete a note" — this is a documentation error. The correct behavior is soft delete (is_archived=true), consistent with the database schema, the `is_archived` filter on GET /notes, and this story. The arch doc should be updated separately.

---

## Testing

### Testing Standards

**Test File Locations:**

- Unit tests: `backend/tests/unit/services/notes.update.test.ts`
- Integration tests: `backend/tests/integration/routes/notes.read.test.ts`
- Integration tests: `backend/tests/integration/routes/notes.update.test.ts`
- Integration tests: `backend/tests/integration/routes/notes.delete.test.ts`

**Testing Frameworks:**

- Test Runner: Bun Test (built-in)
- Assertion: Bun's expect() API (Jest-compatible)

**Test Coverage Requirements:**

- Content change detection (content vs non-content updates)
- Authorization and user isolation
- Soft delete behavior (is_archived flag)
- Partial update handling
- Error scenarios (404, 400, 401)
- Embedding queue integration

**Critical Test Scenarios:**

1. Get single note with correct ownership
2. Update detects content change and requeues embedding
3. Update preserves embedding_status for non-content changes
4. Delete softly archives note (is_archived=true)
5. User can't access/modify/delete other user's notes
6. Archived notes excluded from default list

---

## Change Log

| Date       | Version | Description                                           | Author       |
| ---------- | ------- | ----------------------------------------------------- | ------------ |
| 2026-02-17 | 0.1     | Initial story draft with read/update/delete endpoints | Scrum Master |
| 2026-02-20 | 0.2     | PO review fixes: AC #19 corrected to 404, Task 1 UnauthorizedError removed, Task 3 findByUserAndId clarified, Task 4 misleading embedding text removed, arch doc discrepancy noted | Product Owner |

---

## Dev Agent Record

_This section will be populated during development_

### Agent Model Used

[To be filled by dev agent]

### Debug Log References

[To be filled by dev agent]

### Completion Notes List

[To be filled by dev agent]

### File List

[To be filled by dev agent]

---

## QA Results

_This section will be populated after QA review_

[To be filled by QA agent]
