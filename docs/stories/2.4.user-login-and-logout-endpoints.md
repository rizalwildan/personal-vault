# Story 2.4: User Login and Logout Endpoints

**Status:** Not Started
**Priority:** High
**Estimate:** 2-3 days
**Epic:** Epic 2 — Backend Authentication System

---

## Story

**As a** backend developer,
**I want** complete login and logout endpoints,
**so that** users can authenticate with their credentials and securely revoke their sessions.

---

## Acceptance Criteria

1. `POST /api/v1/auth/login` validates user credentials against database
2. Returns 401 Unauthorized for invalid email or password
3. Returns 200 OK with user data and tokens on successful authentication
4. Creates new session record in sessions table with refresh token hash
5. `POST /api/v1/auth/logout` accepts refresh_token in request body
6. Logout deletes the corresponding session from database (token revocation)
7. Returns 200 OK after successful logout
8. Integration tests cover all success and error scenarios

---

## Tasks / Subtasks

- [ ] Extend auth routes in `backend/src/routes/auth.ts`
  - [ ] Add login endpoint to existing auth router
  - [ ] Add logout endpoint to existing auth router
  - [ ] Import additional utilities and schemas as needed
- [ ] Implement login endpoint logic
  - [ ] Parse and validate request body with `LoginSchema`
  - [ ] Query user by email from database
  - [ ] Compare provided password with stored hash using `comparePassword`
  - [ ] Generate access and refresh tokens on success
  - [ ] Store refresh token hash in sessions table
  - [ ] Return success response with user data and tokens
- [ ] Implement logout endpoint logic
  - [ ] Accept refresh_token in request body
  - [ ] Compute SHA-256 hash of provided token
  - [ ] Delete session record matching the token hash
  - [ ] Return success response
- [ ] Implement error handling
  - [ ] 401 Unauthorized for invalid credentials (login)
  - [ ] 400 Bad Request for missing/invalid refresh token (logout)
  - [ ] Generic error messages to prevent credential enumeration
- [ ] Update existing auth routes mounting (if needed)
  - [ ] Verify routes are properly mounted in main app
  - [ ] Test endpoints are accessible
- [ ] Write comprehensive integration tests
  - [ ] Test successful login with valid credentials
  - [ ] Test login failure with invalid email
  - [ ] Test login failure with invalid password
  - [ ] Test successful logout with valid refresh token
  - [ ] Test logout failure with invalid refresh token
  - [ ] Verify database session records are created/deleted correctly
  - [ ] Verify tokens are valid and usable

---

## Dev Notes

### Previous Story Context

**From Story 2.3 (User Registration Endpoint):**

- Auth routes file `backend/src/routes/auth.ts` created
- Registration endpoint implemented and tested
- Database operations for user creation established
- Session creation logic already implemented

**From Story 2.2 (JWT Utilities and Password Hashing):**

- Password comparison utility (`comparePassword`) implemented
- JWT token generation utilities available
- SHA-256 hashing for refresh tokens established

**From Story 2.1 (Database Schema for Users and Sessions):**

- Users and sessions tables available
- Database queries for user lookup working
- Session deletion operations possible

### Source Tree Context

Current project structure (relevant portions):

```
personal-vault/
├── backend/
│   ├── src/
│   │   ├── app.ts                # EXISTS - Main Hono app
│   │   ├── routes/
│   │   │   ├── index.ts          # EXISTS - Route exports
│   │   │   └── auth.ts           # EXISTS - From Story 2.3
│   │   ├── utils/
│   │   │   └── auth.ts           # EXISTS - Auth utilities
│   │   ├── db/
│   │   │   ├── client.ts         # EXISTS - Database connection
│   │   │   └── schema/
│   │   │       ├── index.ts      # EXISTS - Schema exports
│   │   │       ├── users.ts      # EXISTS - Users schema
│   │   │       └── sessions.ts   # EXISTS - Sessions schema
│   ├── tests/
│   │   ├── integration/
│   │   │   └── auth.test.ts      # EXISTS - From Story 2.3
│   ├── package.json              # EXISTS - Dependencies
│   └── tsconfig.json             # EXISTS - TypeScript config
├── shared/
│   └── schemas/
│       ├── index.ts              # EXISTS - Schema exports
│       ├── user.ts               # EXISTS - User schemas
│       └── session.ts            # EXISTS - Session schemas
```

### API Contract Details

**Login Endpoint:** `POST /api/v1/auth/login`

**Request Body Schema:**

```typescript
// From shared/schemas/user.ts
export const LoginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(1),
});
```

**Success Response (200 OK):**

```typescript
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid-string",
      "email": "user@example.com",
      "name": "John Developer",
      "avatar_url": null,
      "terms_accepted_at": "2026-02-17T10:30:00Z",
      "created_at": "2026-02-17T10:30:00Z",
      "updated_at": "2026-02-17T10:30:00Z"
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**Error Response (401 Unauthorized):**

```typescript
{
  "success": false,
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Invalid email or password"
  }
}
```

**Logout Endpoint:** `POST /api/v1/auth/logout`

**Request Body:**

```typescript
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Success Response (200 OK):**

```typescript
{
  "success": true,
  "message": "Logged out successfully"
}
```

**Error Response (400 Bad Request):**

```typescript
{
  "success": false,
  "error": {
    "code": "INVALID_TOKEN",
    "message": "Invalid refresh token"
  }
}
```

### Implementation Details

**Login Endpoint Implementation:**

```typescript
// backend/src/routes/auth.ts (extending existing file)
import { Hono } from 'hono';
import { zValidator } from '@hono/zod-validator';
import { LoginSchema } from '../../../shared/schemas/user';
import { db } from '../db/client';
import { users, sessions } from '../db/schema';
import { eq } from 'drizzle-orm';
import {
  comparePassword,
  signAccessToken,
  signRefreshToken,
} from '../utils/auth';
import { createHash } from 'crypto';

// ... existing registration code ...

auth.post('/login', zValidator('json', LoginSchema), async (c) => {
  const { email, password } = c.req.valid('json');

  // Find user by email
  const user = await db.query.users.findFirst({
    where: eq(users.email, email),
  });

  if (!user) {
    return c.json(
      {
        success: false,
        error: {
          code: 'INVALID_CREDENTIALS',
          message: 'Invalid email or password',
        },
      },
      401,
    );
  }

  // Verify password
  const isValidPassword = await comparePassword(password, user.password_hash);
  if (!isValidPassword) {
    return c.json(
      {
        success: false,
        error: {
          code: 'INVALID_CREDENTIALS',
          message: 'Invalid email or password',
        },
      },
      401,
    );
  }

  // Generate tokens
  const accessToken = await signAccessToken(user.id);
  const refreshToken = await signRefreshToken(user.id);

  // Store refresh token hash in sessions
  const refreshTokenHash = createHash('sha256')
    .update(refreshToken)
    .digest('hex');
  await db.insert(sessions).values({
    user_id: user.id,
    token_hash: refreshTokenHash,
    expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
  });

  // Return success response
  return c.json({
    success: true,
    data: {
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        avatar_url: user.avatar_url,
        terms_accepted_at: user.terms_accepted_at,
        created_at: user.created_at,
        updated_at: user.updated_at,
      },
      access_token: accessToken,
      refresh_token: refreshToken,
    },
  });
});

// ... existing code ...
```

**Logout Endpoint Implementation:**

```typescript
// backend/src/routes/auth.ts (extending existing file)
// ... existing imports ...

auth.post('/logout', async (c) => {
  const { refresh_token } = await c.req.json();

  if (!refresh_token) {
    return c.json(
      {
        success: false,
        error: {
          code: 'INVALID_TOKEN',
          message: 'Refresh token is required',
        },
      },
      400,
    );
  }

  // Compute hash of provided token
  const tokenHash = createHash('sha256').update(refresh_token).digest('hex');

  // Delete session with matching token hash
  const result = await db
    .delete(sessions)
    .where(eq(sessions.token_hash, tokenHash));

  // Check if any session was deleted
  if (result.rowCount === 0) {
    return c.json(
      {
        success: false,
        error: {
          code: 'INVALID_TOKEN',
          message: 'Invalid refresh token',
        },
      },
      400,
    );
  }

  return c.json({
    success: true,
    message: 'Logged out successfully',
  });
});

// ... existing code ...
```

### Database Operations

**Login:**

- Query users table by email
- Insert new session record with refresh token hash

**Logout:**

- Delete from sessions table where token_hash matches computed hash
- Use rowCount to verify deletion occurred

### Security Considerations

- **Credential Security:** Use generic error messages to prevent email enumeration
- **Token Security:** Store only refresh token hashes, never plaintext tokens
- **Session Management:** Each login creates a new session (multiple concurrent sessions allowed)
- **Logout Security:** Only the refresh token can revoke its own session
- **Timing Attacks:** Constant-time password comparison (handled by bcrypt)

### Testing Strategy

**Integration Tests:**

```typescript
// backend/tests/integration/auth.test.ts (extending existing file)

describe('POST /api/v1/auth/login', () => {
  it('should authenticate user successfully', async () => {
    // Create test user first
    await testClient.post('/api/v1/auth/register').json({
      email: 'login-test@example.com',
      password: 'SecurePass123',
      name: 'Login Test',
      terms_accepted: true,
    });

    const response = await testClient.post('/api/v1/auth/login').json({
      email: 'login-test@example.com',
      password: 'SecurePass123',
    });

    expect(response.status).toBe(200);
    const data = await response.json();
    expect(data.success).toBe(true);
    expect(data.data.user.email).toBe('login-test@example.com');
    expect(data.data.access_token).toBeDefined();
    expect(data.data.refresh_token).toBeDefined();
  });

  it('should reject invalid email', async () => {
    const response = await testClient.post('/api/v1/auth/login').json({
      email: 'nonexistent@example.com',
      password: 'SomePassword123',
    });

    expect(response.status).toBe(401);
    const data = await response.json();
    expect(data.error.code).toBe('INVALID_CREDENTIALS');
  });

  it('should reject invalid password', async () => {
    // Create test user
    await testClient.post('/api/v1/auth/register').json({
      email: 'wrong-pass@example.com',
      password: 'CorrectPass123',
      name: 'Wrong Pass Test',
      terms_accepted: true,
    });

    const response = await testClient.post('/api/v1/auth/login').json({
      email: 'wrong-pass@example.com',
      password: 'WrongPass123',
    });

    expect(response.status).toBe(401);
    const data = await response.json();
    expect(data.error.code).toBe('INVALID_CREDENTIALS');
  });
});

describe('POST /api/v1/auth/logout', () => {
  it('should logout user successfully', async () => {
    // Register and login first
    await testClient.post('/api/v1/auth/register').json({
      email: 'logout-test@example.com',
      password: 'SecurePass123',
      name: 'Logout Test',
      terms_accepted: true,
    });

    const loginResponse = await testClient.post('/api/v1/auth/login').json({
      email: 'logout-test@example.com',
      password: 'SecurePass123',
    });

    const { refresh_token } = await loginResponse.json().data;

    // Now logout
    const logoutResponse = await testClient
      .post('/api/v1/auth/logout')
      .json({ refresh_token });

    expect(logoutResponse.status).toBe(200);
    const data = await logoutResponse.json();
    expect(data.success).toBe(true);
    expect(data.message).toBe('Logged out successfully');
  });

  it('should reject invalid refresh token', async () => {
    const response = await testClient
      .post('/api/v1/auth/logout')
      .json({ refresh_token: 'invalid-token' });

    expect(response.status).toBe(400);
    const data = await response.json();
    expect(data.error.code).toBe('INVALID_TOKEN');
  });
});
```

### Performance Considerations

- Database queries for user lookup and session management
- Password verification is CPU-intensive but necessary
- Session creation on each login (acceptable for security)
- Session deletion by token hash (indexed for performance)

### Dependencies

**Runtime Dependencies:**

- `crypto` - Node.js built-in for SHA-256 hashing
- Existing dependencies from previous stories

**Development Dependencies:**

- Test utilities for integration testing

---

## Change Log

| Date       | Version | Description               | Author             |
| ---------- | ------- | ------------------------- | ------------------ |
| 2026-02-17 | 0.1     | Initial draft from Epic 2 | Bob (Scrum Master) |

---

## File List

**Source Files to Modify:**

- `backend/src/routes/auth.ts` - Add login and logout endpoints
- `backend/tests/integration/auth.test.ts` - Add login/logout tests

**Source Files to Verify:**

- `backend/src/utils/auth.ts` - Password and JWT utilities
- `backend/src/db/schema/index.ts` - Schema exports
- `shared/schemas/user.ts` - LoginSchema validation
- `backend/src/app.ts` - Routes properly mounted

---

## Dev Agent Record

**Agent Model Used:** Grok Code Fast 1

**Debug Log References:** None - draft only.

**Completion Notes List:**

- Story drafted based on Epic 2 requirements
- Complete API contracts for both login and logout
- Implementation details with security considerations
- Comprehensive testing strategy included

---

## QA Results

**Not Applicable** - Story not yet implemented.

### Recommended Status

Ready for development assignment.</content>
<parameter name="filePath">/Users/developer/NodeProject/personal-vault/docs/stories/2.4.user-login-and-logout-endpoints.md
