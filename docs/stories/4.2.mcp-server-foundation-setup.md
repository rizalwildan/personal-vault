# Story 4.2: MCP Server Foundation Setup

**Status:** Done

**Epic:** Epic 4 - Backend Search & MCP Server Integration

---

## Story

**As a** developer integrating the Personal Vault with AI assistants (Cursor, VS Code, Claude Desktop),
**I want** a working MCP server foundation using `@modelcontextprotocol/sdk` with stdio transport,
**so that** subsequent stories (4.3–4.5) can build on a stable, correctly initialized MCP server capable of listing resources and being connected by MCP clients.

---

## Acceptance Criteria

1. `@modelcontextprotocol/sdk` is installed in `backend/package.json` as a production dependency
2. MCP server initializes successfully without errors when `backend/src/mcp/server.ts` is run directly
3. Server exposes correct metadata: `name: 'bmad-personal-vault'`, `version: '1.0.0'`
4. Server declares capabilities: `{ resources: {}, tools: {} }`
5. Stdio transport connects and the server can accept MCP protocol requests
6. `resources/list` request handler is registered and returns a valid (empty) response `{ resources: [] }`
7. Health/status method on `MCPService` returns `{ isInitialized: boolean, transport: string, serverName: string }`
8. Server startup and transport connection events are logged to console (verified by code review, not unit test)
9. `mcpService` singleton is exported from `backend/src/services/mcp.service.ts` for use by future HTTP route integration (Story 4.5)
10. `backend/package.json` includes a `"mcp:stdio"` script: `"bun run src/mcp/server.ts"`

---

## Tasks / Subtasks

- [x] **Task 1: Install `@modelcontextprotocol/sdk`** (AC: 1)
  - [x] Run `bun add @modelcontextprotocol/sdk` in `backend/`
  - [x] Verify package appears in `backend/package.json` under `dependencies`
  - [x] **After installing:** Check installed version in `backend/node_modules/@modelcontextprotocol/sdk/package.json` and read Dev Notes section "SDK API Version Check" to determine which `setRequestHandler` API to use

- [x] **Task 2: Create `MCPService` class in `backend/src/services/mcp.service.ts`** (AC: 2, 3, 4, 6, 7, 8, 9)
  - [x] Import `Server` from `@modelcontextprotocol/sdk/server/index.js`
  - [x] Import `StdioServerTransport` from `@modelcontextprotocol/sdk/server/stdio.js`
  - [x] Import request schemas (see Dev Notes "SDK API Version Check" for correct import path and approach)
  - [x] Instantiate `Server` with metadata `{ name: 'bmad-personal-vault', version: '1.0.0' }` and capabilities `{ resources: {}, tools: {} }`
  - [x] Register `resources/list` stub handler returning `{ resources: [] }` (see Dev Notes for schema-based vs string-based approach)
  - [x] Implement `async startStdio(): Promise<void>` — creates `StdioServerTransport`, calls `server.connect(transport)`, logs connection event, stores transport type on instance
  - [x] Implement `getStatus(): { isInitialized: boolean; transport: string; serverName: string }` — returns current state
  - [x] Add `console.log` for: server created, transport connected; `console.error` for connection errors
  - [x] Export `export const mcpService = new MCPService()` singleton at the bottom of the file

- [x] **Task 3: Create standalone stdio entry point and add run script** (AC: 2, 5, 8, 10)
  - [x] Create new directory `backend/src/mcp/` — **this is a new directory not in the architecture source tree; it is intentionally added to house the standalone MCP entry point**
  - [x] Create `backend/src/mcp/server.ts`: import `mcpService` from `../services/mcp.service`, call `await mcpService.startStdio()` in a `try/catch` that `console.error`s and exits with `process.exit(1)` on failure
  - [x] Add `"mcp:stdio": "bun run src/mcp/server.ts"` to the `scripts` block in `backend/package.json`

- [x] **Task 4: Write unit tests for `MCPService`** (AC: 2, 3, 4, 6, 7)
  - [x] Create `backend/tests/unit/services/mcp.service.test.ts`
  - [x] Test: `getStatus()` returns `{ isInitialized: false, transport: 'none', serverName: 'bmad-personal-vault' }` before `startStdio()` is called
  - [x] Test: `getStatus().serverName` equals `'bmad-personal-vault'` (verifies AC3 metadata)
  - [x] Test: `resources/list` handler returns `{ resources: [] }` — use `Client` + `InMemoryTransport` from the MCP SDK to connect a test client to the server and call `client.listResources()` (see Dev Notes "Testing resources/list with InMemoryTransport" for exact pattern)

---

## Dev Notes

### Previous Story Insights (4.1 Semantic Search)

- `searchService.semanticSearch()` is fully implemented at `backend/src/services/search.service.ts`. Story 4.4 (MCP Tools) will import and reuse this function directly — no re-implementation needed.
- **Auth middleware pattern:** The actual implementation differs from the architecture doc. Auth is a plain `async function authMiddleware(ctx)` at `backend/src/middleware/auth.ts` — NOT an Elysia `.derive()` plugin. It is called manually at the top of each route handler: `const authResult = await authMiddleware(ctx); if (authResult) return authResult;`. On success it sets `ctx.currentUser` (full User DB object). This pattern is used in Story 4.5 (SSE route) if auth is needed.
- **Route prefix pattern:** Routes define their full path in the Elysia prefix (e.g., `new Elysia({ prefix: '/api/v1/search' })`). There is **no** `/api/v1` group wrapping in `app.ts`. When Story 4.5 creates `mcp.routes.ts`, it should use `prefix: '/api/v1/mcp'`.
- **No `/api/v1` group in `app.ts`:** The actual `app.ts` registers routes flat — `app.use(searchRoutes)` without a group wrapper. The architecture doc's `app.group('/api/v1', ...)` pattern is NOT how the codebase is implemented.

### Architecture: MCP SDK

**Package:** `@modelcontextprotocol/sdk` — NOT yet installed in `backend/package.json`. Must be added in Task 1.
[Source: architecture/tech-stack.md#technology-stack-table]

**Always-safe imports (confirmed in architecture doc):**

```typescript
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
```

[Source: architecture/backend-architecture.md#mcp-protocol-implementation]

### SDK API Version Check — `setRequestHandler` Approach

> **⚠️ IMPORTANT — Read before writing `setRequestHandler` calls.**

Two different APIs exist depending on the installed SDK version:

**Option A — Schema-based (SDK v1.x+, newer)** — used in the epic code:

```typescript
// Import schemas from the types module
import { ListResourcesRequestSchema } from '@modelcontextprotocol/sdk/types.js';

// Register handler with Zod schema as first arg
server.setRequestHandler(ListResourcesRequestSchema, async () => ({
  resources: [],
}));
```

**Option B — String-based (older SDK, pre-1.0)** — used in `backend-architecture.md`:

```typescript
// No schema import needed
server.setRequestHandler('resources/list', async (_request) => ({
  resources: [],
}));
```

**How to determine which to use after `bun add`:**

1. Open `backend/node_modules/@modelcontextprotocol/sdk/package.json` and check `"version"`
2. If version is `>=1.0.0`: use **Option A** (schema-based)
3. If version is `<1.0.0`: use **Option B** (string-based)
4. If `ListResourcesRequestSchema` is not exported from `@modelcontextprotocol/sdk/types.js`, try `@modelcontextprotocol/sdk` (main export), then fall back to **Option B**

**Option B is the safe fallback** — it is confirmed in the architecture doc and works regardless of version.

[Source: architecture/backend-architecture.md#mcp-protocol-implementation (string-based), epic-4-backend-search-mcp.md#story-3 (schema-based)]

### Architecture: MCPService Class

The `MCPService` must be designed as a singleton that can be started with either stdio (Story 4.2) or SSE transport (Story 4.5). It holds the `Server` instance and registers all handlers.

**Implementation pattern (uses Option A; substitute Option B if needed per version check above):**

```typescript
// backend/src/services/mcp.service.ts
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
// Option A only — remove if using Option B:
import { ListResourcesRequestSchema } from '@modelcontextprotocol/sdk/types.js';

class MCPService {
  private server: Server;
  private currentTransport: string = 'none';
  private initialized: boolean = false;

  constructor() {
    this.server = new Server(
      { name: 'bmad-personal-vault', version: '1.0.0' },
      { capabilities: { resources: {}, tools: {} } },
    );
    this.registerResourceHandlers();
    // Tools handlers registered in Story 4.4
  }

  private registerResourceHandlers(): void {
    // Option A (schema-based, SDK v1.x+):
    this.server.setRequestHandler(ListResourcesRequestSchema, async () => ({
      resources: [],
    }));

    // Option B (string-based fallback):
    // this.server.setRequestHandler('resources/list', async () => ({ resources: [] }));
  }

  async startStdio(): Promise<void> {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    this.currentTransport = 'stdio';
    this.initialized = true;
    console.log('✅ MCP Server connected via stdio transport');
  }

  getStatus(): {
    isInitialized: boolean;
    transport: string;
    serverName: string;
  } {
    return {
      isInitialized: this.initialized,
      transport: this.currentTransport,
      serverName: 'bmad-personal-vault',
    };
  }
}

export const mcpService = new MCPService();
```

[Source: architecture/backend-architecture.md#mcp-protocol-implementation, architecture/components.md#5-mcp-service]

> **⚠️ Name discrepancy:** `backend-architecture.md` uses `name: 'personal-vault'`. The epic code and AC3 both specify `name: 'bmad-personal-vault'`. **Use `'bmad-personal-vault'`.**

### Architecture: MCP Workflows

The MCP integration flow (from architecture) shows:

- AI Assistant → MCP Client → `POST /mcp/messages` (HTTP) → Backend → DB
- OR AI Assistant → MCP Client → stdio → Backend process → DB

Story 4.2 covers only the **stdio transport foundation**. HTTP/SSE transport endpoint (`GET /mcp/sse`) is Story 4.5.
[Source: architecture/core-workflows.md#4-mcp-integration-flow]

### File Locations

**New files to create:**

- `backend/src/services/mcp.service.ts` — MCPService class + singleton export
- `backend/src/mcp/server.ts` — standalone stdio entry point

**New directory:**

- `backend/src/mcp/` — **not present in the architecture source tree** (`backend-architecture.md` has no `mcp/` directory). This is an intentional addition to house the standalone MCP server entry point, separate from the service layer. The architecture shows the service at `backend/src/services/mcp.service.ts` (which exists here), but the standalone entry point is a new concept from the epic.
  [Source: architecture/backend-architecture.md#directory-structure — note deviation]

**Modified files:**

- `backend/package.json` — add `@modelcontextprotocol/sdk` to `dependencies` (via `bun add`), and add `"mcp:stdio"` to `scripts`

**NOT modified in this story:**

- `backend/src/app.ts` — MCP HTTP routes not added until Story 4.5; no swagger tag needed yet
- `backend/src/index.ts` — MCPService does NOT need initialization at HTTP server startup; it is started via the standalone `mcp/server.ts` entry point for stdio use

[Source: architecture/backend-architecture.md#directory-structure, architecture/unified-project-structure.md]

### Coding Standards

- **No `any` types** — `@typescript-eslint/no-explicit-any: "error"`. Do not use `any` in MCPService. If the SDK types require a workaround, use `unknown` with explicit casts.
- **Strict mode:** `strict: true`, `noUncheckedIndexedAccess: true`, `noUnusedLocals: true`, `noUnusedParameters: true`
- **`prefer-const`: "error"** — always use `const` for non-reassigned variables
- **No `console.log`** in production route/service code per ESLint rules (`no-console: warn`) — use `console.error` for errors; `console.log` is acceptable only for startup/connection lifecycle events
- Service file naming: `camelCase.service.ts` → `mcp.service.ts` ✓

[Source: architecture/coding-standards.md]

### Testing

**Test runner:** Bun Test (`bun:test`)
**Unit test file:** `backend/tests/unit/services/mcp.service.test.ts`
**No integration tests required for this story** — integration tests for the HTTP-facing MCP surface are in Story 4.5.
**Coverage targets:** Services >90% [Source: architecture/testing-strategy.md#test-coverage-requirements]

#### Basic status tests

```typescript
import { describe, test, expect } from 'bun:test';
import { mcpService } from '../../src/services/mcp.service';

describe('MCPService', () => {
  test('getStatus returns correct initial state before startStdio()', () => {
    const status = mcpService.getStatus();
    expect(status.isInitialized).toBe(false);
    expect(status.transport).toBe('none');
    expect(status.serverName).toBe('bmad-personal-vault');
  });
});
```

#### Testing `resources/list` with InMemoryTransport (AC: 6)

The MCP SDK ships an `InMemoryTransport` for exactly this use case — connecting a test client to a server without a real network or process. Use it to verify the handler returns the correct shape:

```typescript
import { Client } from '@modelcontextprotocol/sdk/client/index.js';
import { InMemoryTransport } from '@modelcontextprotocol/sdk/inMemory.js';

test('resources/list handler returns empty resources array', async () => {
  // Create a fresh Server instance for this test (don't reuse the singleton
  // which may already be connected to a transport)
  const { MCPService } = await import('../../src/services/mcp.service');
  // If MCPService class is not exported separately, instantiate a new one
  // by importing the module fresh and accessing the internal server via a
  // test-only getter, OR construct as shown:

  const [clientTransport, serverTransport] =
    InMemoryTransport.createLinkedPair();

  // Connect the singleton's internal server to the test transport
  // This requires exposing the Server instance — add a package-private
  // getter `getServer(): Server` to MCPService for testing:
  const server = mcpService.getServer(); // see note below
  await server.connect(serverTransport);

  const client = new Client(
    { name: 'test-client', version: '1.0.0' },
    { capabilities: {} },
  );
  await client.connect(clientTransport);

  const result = await client.listResources();
  expect(result.resources).toEqual([]);

  await client.close();
});
```

> **`getServer()` note:** To avoid making the `server` field `public`, add a protected/package-level getter to `MCPService`:
>
> ```typescript
> getServer(): Server { return this.server; }
> ```
>
> This is test scaffolding only — it does not affect production behaviour and is consistent with the coding standards (it is typed, not `any`).

> **InMemoryTransport import path note:** If `@modelcontextprotocol/sdk/inMemory.js` is not found after installing the SDK, check `node_modules/@modelcontextprotocol/sdk/` for the actual filename (may be `inMemory.js`, `inmemory.js`, or exported from the main index). The `Client` is at `@modelcontextprotocol/sdk/client/index.js`.

[Source: architecture/testing-strategy.md#backend-testing]

---

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                                                                                                     | Author   |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| 2026-02-22 | 1.0     | Initial draft                                                                                                                                                                                                                                                                                                                                                   | Bob (SM) |
| 2026-02-22 | 1.1     | PO validation fixes: resolved `setRequestHandler` API ambiguity (schema vs string, version-dependent), clarified import paths with fallback guidance, acknowledged `backend/src/mcp/` as new directory, added `mcp:stdio` package.json script (AC10), replaced vague AC6 test with definitive `InMemoryTransport` pattern, rephrased AC8 as implementation note | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

None

### Completion Notes List

- **SDK Version:** Installed `@modelcontextprotocol/sdk` v1.26.0, which uses the new `McpServer` API. The deprecated `Server` class is available but not recommended.
- **API Changes:** Used `McpServer` from `@modelcontextprotocol/sdk/server/mcp.js` instead of deprecated `Server`. McpServer provides a higher-level API with lazy handler registration.
- **Handler Initialization:** Discovered that `McpServer` uses lazy handler registration — handlers are only set up when the first resource/tool/prompt is registered. Implemented a workaround by registering and immediately removing a dummy resource during construction to ensure `resources/list` handler is available before `connect()`.
- **Zod Upgrade:** Upgraded `zod` from 3.24.1 to 3.25.76 to satisfy MCP SDK peer dependency requirement (`^3.25 || ^4.0`).
- **Testing Pattern:** Used `InMemoryTransport.createLinkedPair()` pattern from SDK to test resource listing without actual stdio/network transport.

### File List

**Created:**

- `backend/src/services/mcp.service.ts` — MCPService singleton with McpServer instance
- `backend/src/mcp/server.ts` — Standalone stdio entry point
- `backend/tests/unit/services/mcp.service.test.ts` — Unit tests for MCPService

**Modified:**

- `backend/package.json` — Added `@modelcontextprotocol/sdk@^1.26.0` dependency, upgraded `zod` to `3.25.76`, added `mcp:stdio` script

---

## QA Results

### Review Date: 2026-02-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Solid foundation implementation. The dev made a well-reasoned pragmatic choice to use `McpServer` (high-level API) over the deprecated `Server` class, which is correct for SDK v1.26.0. All 3 unit tests pass cleanly and all 10 ACs are functionally met. The main concerns are a fragile SDK workaround and minor testability gaps — no blocking defects.

The 25 pre-existing test failures across the suite are unrelated to Story 4.2 (Auth middleware pattern mismatch, EmbeddingQueue timeouts, PATCH/Tags integration failures). Story 4.2's tests are clean.

### Refactoring Performed

None — no refactoring was safe to apply without risk to the SDK workaround's delicate initialization sequence.

### Compliance Check

- Coding Standards: ✓ (no `any` types, strict mode, `prefer-const`, typed return types) — minor: `console.log` in constructor fires at import time during tests (noisy but not blocking)
- Project Structure: ✓ (`backend/src/mcp/` deviation is intentional and documented)
- Testing Strategy: ✓ (`InMemoryTransport` pattern used correctly; 3 tests, all pass)
- All ACs Met: ✓ (AC4 met implicitly via `McpServer` capability negotiation — functionally equivalent, see IMPL-001 below)

### Improvements Checklist

- [ ] **IMPL-001 (medium)**: `initializeResourceHandling()` uses a fragile hack — registers then immediately removes a dummy resource to trigger `McpServer`'s lazy handler initialization. If the SDK updates its lazy-init behavior this silently breaks `resources/list`. Monitor on each `@modelcontextprotocol/sdk` upgrade. Consider replacing with a direct SDK call if the API exposes one in future versions. (`backend/src/services/mcp.service.ts:22-32`)
- [ ] **ARCH-001 (low)**: `MCPService` class is not exported — only the singleton. The `resources/list` test works around this by constructing a raw `McpServer` directly, duplicating the initialization logic. For Stories 4.4/4.5, consider `export { MCPService }` alongside the singleton to allow isolated unit testing of handler registration without duplicating SDK setup. (`backend/src/services/mcp.service.ts`)
- [ ] **TEST-001 (low)**: Test 2 ("getStatus().serverName equals bmad-personal-vault") is fully redundant — Test 1 already asserts all three fields including `serverName`. Remove to reduce test noise. (`backend/tests/unit/services/mcp.service.test.ts:17-20`)
- [ ] **STYLE-001 (low)**: `console.log('✅ MCP Server instance created')` in the constructor fires at module import time, including during every test run (visible as `✅ MCP Server instance created` in test output). Startup messaging is better placed in `startStdio()` where it reflects actual server startup, not class instantiation. (`backend/src/services/mcp.service.ts:14`)

### Security Review

No security concerns. The MCP server operates over stdio (local process boundary only). No network exposure in this story. No auth, no data access, no secrets handling.

### Performance Considerations

The `initializeResourceHandling()` workaround executes synchronously at construction time with minimal overhead (one SDK registration + removal). No performance concerns for this story.

### Files Modified During Review

None. No refactoring was performed.

### Gate Status

Gate: CONCERNS → docs/qa/gates/4.2-mcp-server-foundation-setup.yml
Risk profile: N/A (not run for this story)
NFR assessment: Inline above

### Recommended Status

✓ Ready for Done — one medium and three low concerns logged; no blocking defects. Team should address IMPL-001 during Story 4.4/4.5 work when the service is extended, or accept the risk explicitly.
